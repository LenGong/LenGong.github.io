"use strict";

var simpleGui={canvas:undefined,canvasContext:undefined,draw:undefined,update:undefined,createTimer:function(c,a){var b=function(){this.time=c;this.callfun=a};b.prototype={constructor:b,start:function(){d.callfun();setTimeout(d.start,d.time)},};var d=new b;return d},createFrame:function(b){var a=function(){simpleGui.canvas=b;simpleGui.canvasContext=simpleGui.canvas.getContext("2d");this.flag=false};a.prototype={constructor:a,setCanvasBackground:function(d,c){simpleGui.canvas.style.backgroundColor=d||"rgb(0,0,0)";simpleGui.canvas.style.backgroundImage=c},setClickHandle:function(c){simpleGui.canvas.onmousedown=function(f){var g=parseInt(this.style.borderLeftWidth)||0;var e=parseInt(this.style.borderTopWidth)||0;var d=f.clientX-this.getBoundingClientRect().left-g;var h=f.clientY-this.getBoundingClientRect().top-e;c([d,h])}},setKeyupHandle:function(c){document.onkeyup=function(d){
if(d.keyCode==32||d.keyCode==37||d.keyCode==38||d.keyCode==39 ||d.keyCode==40){
    d.preventDefault();
  }
  c(d.keyCode);this.flag=false}},setKeydownHandle:function(c){document.onkeydown=function(d){
    if(d.keyCode==32||d.keyCode==37||d.keyCode==38||d.keyCode==39||d.keyCode==40){
    d.preventDefault()};
    if(!this.flag){c(d.keyCode)}this.flag=true}},setDrawHandle:function(c){draw=c},start:function(){simpleGui.mainLoop()}};return new a()},mainLoop:function(){simpleGui.canvasContext.clearRect(0,0,simpleGui.canvas.width,simpleGui.canvas.height);draw(simpleGui.canvasin);window.setTimeout(simpleGui.mainLoop,1000/60)},loadImage:function(b){var a=new Image();a.src=b;return a},loadAudio:function(b){var a=new Audio();a.src=b;return a},canvasin:{drawText:function(c,d,b,a){simpleGui.canvasContext.font=b+"px 宋体";simpleGui.canvasContext.fillStyle=a;simpleGui.canvasContext.fillText(c,d[0],d[1])},drawImage:function(e,c,k,g,a,b){var d=b||0;var l=new Image();l.src=e.src;var h=c[0]-k[0]/2;var f=c[1]-k[1]/2;var j=g[0]-c[0]%k[0]-(a[0]-k[0])/2;var i=g[1]-c[1]%k[1]-(a[1]-k[1])/2;simpleGui.canvasContext.save();simpleGui.canvasContext.translate(g[0],g[1]);simpleGui.canvasContext.rotate(d);simpleGui.canvasContext.translate(-g[0],-g[1]);simpleGui.canvasContext.drawImage(l,h,f,k[0],k[1],j,i,a[0],a[1]);simpleGui.canvasContext.restore()},},KEY_MAP:{left:37,up:38,right:39,space:32,},};

var rock_pos = null;
var rock_vel = null;
var rock_avel = null;
var WIDTH=800;var HEIGHT=600;var score=0;var lives=3;var time=0;var started=false;var flag=false;var init_ship=1;var debris2_blue="/public/imgsou/img/debris2_blue.png";var splash="/public/imgsou/img/splash.png";var double_ship="/public/imgsou/img/double_ship.png";var shot2="/public/imgsou/img/shot2.png";var asteroid_blue="/public/imgsou/img/asteroid_blue.png";var explosion_alpha="/public/imgsou/img/explosion_alpha.png";var track="/public/imgsou/sound/soundtrack.mp3";var missile="/public/imgsou/sound/missile.mp3";var thrust="/public/imgsou/sound/thrust.mp3";var explosion="/public/imgsou/sound/explosion.mp3";function imageInfo(b,c,a,e,d){this.center=b;this.size=c;this.radius=a||0;this.lifespan=e||false;this.animated=d||false;if(typeof this.getCenter!="function"){imageInfo.prototype.getCenter=function(){return this.center};imageInfo.prototype.getSize=function(){return this.size};imageInfo.prototype.getRadius=function(){return this.radius};imageInfo.prototype.getLifespan=function(){return this.lifespan};imageInfo.prototype.getAnimated=function(){return this.animated}}}var debris_info=new imageInfo([320,240],[640,480]);var debris_image=simpleGui.loadImage(debris2_blue);var splash_info=new imageInfo([200,150],[400,300]);var splash_image=simpleGui.loadImage(splash);var ship_info=new imageInfo([45,45],[90,90],35);var ship_image=simpleGui.loadImage(double_ship);var missile_info=new imageInfo([5,5],[10,10],3,60);var missile_image=simpleGui.loadImage(shot2);var asteroid_info=new imageInfo([45,45],[90,90],40);var asteroid_image=simpleGui.loadImage(asteroid_blue);var explosion_info=new imageInfo([64,64],[128,128],17,24,true);var explosion_image=simpleGui.loadImage(explosion_alpha);var soundtrack=simpleGui.loadAudio(track);soundtrack.loop=true;soundtrack.volume=0.8;var missile_sound=simpleGui.loadAudio(missile);var ship_thrust_sound=simpleGui.loadAudio(thrust);ship_thrust_sound.loop=true;var explosion_sound=simpleGui.loadAudio(explosion);function angle_to_vector(a){return[Math.cos(a),Math.sin(a)]}function dist(b,a){return Math.sqrt((b[0]-a[0])*(b[0]-a[0])+(b[1]-a[1])*(b[1]-a[1]))}function keydown(a){if(a==simpleGui.KEY_MAP.left){my_ship.decrement_angle_vel()}else{if(a==simpleGui.KEY_MAP.right){my_ship.increment_angle_vel()}else{if(a==simpleGui.KEY_MAP.up){my_ship.set_thrust(true)}else{if(a==simpleGui.KEY_MAP.space){my_ship.shoot()}}}}}function keyup(a){if(a==simpleGui.KEY_MAP.left){my_ship.increment_angle_vel()}else{if(a==simpleGui.KEY_MAP.right){my_ship.decrement_angle_vel()}else{if(a==simpleGui.KEY_MAP.up){my_ship.set_thrust(false)}}}}function click(e){var a=[WIDTH/2,HEIGHT/2];var b=splash_info.getSize();var c=false;var d=false;if((a[0]-b[0]/2)<e[0]&&e[0]<(a[0]+b[0]/2)){c=true}if((a[1]-b[1]/2)<e[0]&&e[0]<(a[0]+b[0]/2)){d=true}if(!started&&c&&d){started=true}soundtrack.play()}function Ship(e,a,d,c,b){this.pos=[e[0],e[1]];this.vel=[a[0],a[1]];this.thrust=false;this.angle=d;this.angle_vel=0;this.image=c;this.image_center=b.getCenter();this.image_size=b.getSize();this.radius=b.getRadius();if(typeof this.draw!="function"){Ship.prototype.draw=function(f){if(this.thrust){f.drawImage(this.image,[this.image_center[0]+this.image_size[0],this.image_center[1]],this.image_size,this.pos,this.image_size,this.angle)}else{f.drawImage(this.image,this.image_center,this.image_size,this.pos,this.image_size,this.angle)}};Ship.prototype.update=function(){this.angle+=this.angle_vel;this.pos[0]=(this.pos[0]+this.vel[0])%WIDTH;this.pos[1]=(this.pos[1]+this.vel[1])%HEIGHT;if(this.pos[0]<0){this.pos[0]=WIDTH}if(this.pos[1]<0){this.pos[1]=HEIGHT}if(this.thrust){var f=angle_to_vector(this.angle);this.vel[0]+=f[0]*0.1;this.vel[1]+=f[1]*0.1}this.vel[0]*=0.99;this.vel[1]*=0.99};Ship.prototype.set_thrust=function(f){this.thrust=f;if(f){ship_thrust_sound.play()}else{ship_thrust_sound.pause()}};Ship.prototype.increment_angle_vel=function(){this.angle_vel+=0.05};Ship.prototype.decrement_angle_vel=function(){this.angle_vel-=0.05};Ship.prototype.shoot=function(){var g=angle_to_vector(this.angle);var f=[this.pos[0]+this.radius*g[0],this.pos[1]+this.radius*g[1]];var h=[this.vel[0]+6*g[0],this.vel[1]+6*g[1]];var i=new Sprite(f,h,this.angle,0,missile_image,missile_info,missile_sound);missile_group.push(i)}}}function Sprite(g,b,a,f,e,d,c){this.pos=[g[0],g[1]];this.vel=[b[0],b[1]];this.angle=a;this.angle_vel=f;this.image=e;this.image_center=d.getCenter();this.image_size=d.getSize();this.radius=d.getRadius();this.lifespan=d.getLifespan();this.animated=d.getAnimated();this.age=0;if(c){c.play()}if(typeof this.draw!="function"){Sprite.prototype.draw=function(h){h.drawImage(this.image,this.image_center,this.image_size,this.pos,this.image_size,this.angle)};Sprite.prototype.update=function(){this.angle+=this.angle_vel;this.pos[0]=(this.pos[0]+this.vel[0])%WIDTH;this.pos[1]=(this.pos[1]+this.vel[1])%HEIGHT;if(this.pos[0]<0){this.pos[0]=WIDTH}if(this.pos[1]<0){this.pos[1]=HEIGHT}if(this.animated){this.image_center[0]+=this.age*this.image_size[0]}this.age+=1;if(this.age==this.lifespan){if(this.animated){this.image_center[0]%=this.age*this.image_size[0]}return true}else{return false}};Sprite.prototype.collide=function(i){var h=dist(this.pos,i.pos);if(h-this.radius-i.radius<=0){return true}else{return false}}}}function draw(b){time++;var e=(time/4)%WIDTH;var a=debris_info.getCenter();var d=debris_info.getSize();b.drawImage(debris_image,a,d,[e-WIDTH/2,HEIGHT/2],[WIDTH,HEIGHT]);b.drawImage(debris_image,a,d,[e+WIDTH/2,HEIGHT/2],[WIDTH,HEIGHT]);b.drawText("战机",[50,50],20,"White");b.drawText("分数",[680,50],20,"White");b.drawText(lives-1,[50,80],22,"White");b.drawText(score,[680,80],22,"White");if(score&&!(score%20)&&flag){init_ship++;flag=false;if(!(score%100)){lives++}}for(var c=0;c<(lives-1);c++){b.drawImage(ship_image,[45,45],[90,90],[80+c*30,75],[400/10,300/10],-1.57)}process_sprite_group(b,rock_group);if(group_collide(my_ship)){lives--;my_ship.pos=[WIDTH/2,HEIGHT/2];my_ship.angle=3.14;my_ship.vel=[0,0]}if(!lives){my_ship.pos=[WIDTH/2,HEIGHT/2];my_ship.angle=3.14;my_ship.vel=[0,0];rock_group.splice(0,rock_group.length);missile_group.splice(0,missile_group.length);lives=3;soundtrack.pause();started=false;score=0;init_ship=1}group_group_collide();process_sprite_group(b,missile_group);process_sprite_group(b,explosion_group);my_ship.draw(b);my_ship.update();if(!started){b.drawImage(splash_image,splash_info.getCenter(),splash_info.getSize(),[WIDTH/2,HEIGHT/2],splash_info.getSize())}}function process_sprite_group(a,c){for(var b in c){c[b].draw(a);if(c[b].update()){c.splice(b,1)}}}function group_collide(a){for(var b in rock_group){if(rock_group[b].collide(a)){explosion_group.push(new Sprite(rock_group[b].pos,[0,0],0,0,explosion_image,explosion_info,explosion_sound));rock_group.splice(b,1);return true}}return false}function group_group_collide(){for(var a in missile_group){if(group_collide(missile_group[a])){missile_group.splice(a,1);score+=10;flag=true}}}function rock_spawner(){if(rock_group.length<init_ship&&started){rock_pos=[Math.random()*WIDTH,Math.random()*HEIGHT];rock_vel=[Math.random()*0.6*init_ship/5-0.3*init_ship/5,Math.random()*0.6*init_ship/5-0.3*init_ship/5];rock_avel=Math.random()*0.2*init_ship/10-0.1*init_ship/10;rock_group.push(new Sprite(rock_pos,rock_vel,0,rock_avel,asteroid_image,asteroid_info))}}var rock_group=[];var missile_group=[];var explosion_group=[];var my_ship=new Ship([WIDTH/2,HEIGHT/2],[0,0],3.14,ship_image,ship_info);
var myflag = true;
document.body.addEventListener("click",function(){
  if(myflag){
  var c=document.getElementById("myCanvas");
  var d=simpleGui.createFrame(c);
  var b="rgba(245,200,21,0.3)";
  var a="url(/public/imgsou/img/nebula_blue.f2014.png)";
  var e=simpleGui.createTimer(1000-init_ship*20,rock_spawner);
  d.setCanvasBackground(b,a);
  d.setClickHandle(click);
  d.setKeyupHandle(keyup);
  d.setKeydownHandle(keydown);
  d.setDrawHandle(draw);
  e.start();
  d.start();
  }

},false);
